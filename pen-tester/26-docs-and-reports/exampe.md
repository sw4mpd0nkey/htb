# Executive Summary 

Inlanefreight Ltd. ("Inlanefreight" herein) contracted Hack The Box Academy to perform a Network Penetration Test of Inlanefreight's internally facing network to identify security weaknesses, determine the impact to Inlanefreight, document all findings in a clear and repeatable manner, and provide remediation recommendations. 

# Approach 

Hack The Box Academy performed testing under a "black box" approach May 12, 2022, to May 31, 2022 without credentials or any advance knowledge of Inlanefreight's internally facing environment with the goal of identifying unknown weaknesses. Testing was performed from a non-evasive standpoint with the goal of uncovering as many misconfigurations and vulnerabilities as possible. Testing was performed remotely via a host that was provisioned specifically for this assessment. Each weakness identified was documented and manually investigated to determine exploitation possibilities and escalation potential. Hack The Box Academy sought to demonstrate the full impact of every vulnerability, up to and including internal domain compromise. If Hack The Box Academy were able to gain a foothold in the internal network, Inlanefreight allowed for further testing including lateral movement and horizontal/vertical privilege escalation to demonstrate the impact of an internal network compromise.

# Internal Network Compromise Walkthrough 

During the course of the assessment Hack The Box Academy was able gain a foothold and compromise the internal network, leading to full administrative control over the INLANEFREIGHT.LOCAL Active Directory domain. The steps below demonstrate the steps taken from initial access to compromise and does not include all vulnerabilities and misconfigurations discovered during the course of testing. Any issues not used as part of the path to compromise are listed as separate, standalone issues in the Technical Findings Details section, ranked by severity level. The intent of this attack chain is to demonstrate to Inlanefreight the impact of each vulnerability shown in this report and how they fit together to demonstrate the overall risk to the client environment and help to prioritize remediation efforts (i.e., patching two flaws quickly could break up the attack chain while the company works to remediate all issues reported). While other findings shown in this report could be leveraged to gain a similar level of access, this attack chain shows the initial path of least resistance taken by the tester to achieve domain compromise . 

# Detailed Walkthrough 
Hack The Box Academy performed the following to fully compromise the INLANEFREIGHT.LOCAL domain. 
1. The tester utilized the Responder tool to obtain an NTLMv2 password hash for a domain user, bsmith. 
2. This password hash was successfully cracked offline using the Hashcat tool to reveal the user's clear text password which granted a foothold into the INLANEFREIGHT.LOCAL domain, but with no more privileges than a standard domain user. 
3. The tester then ran the BloodHound.py , a Python version of the popular SharpHound collection tool to enumerate the domain and create visual representations of attack paths. Upon review, the tester found that multiple privileged users existed in the domain configured with Service Principal Names (SPNs), which can be leveraged to perform a Kerberoasting attack and retrieve TGS Kerberos tickets for the accounts which can be cracked offline using Hashcat if a weak password is set. From here, the tester used the GetUserSPNs.py tool to carry out a targeted Kerberoasting attack against the mssqlsvc account, having found that the mssqlsvc account had local administrator rights over the host SQL01.INLANEFREIGHT.LOCAL which was an interesting target in the domain. 
4. The tester was able to successfully crack this account's password offline, revealing the clear text value. 
5. The tester was able to authenticate to the host SQL01.INLANEFREIGHT.LOCAL and retrieve a clear text password from the host's registry by decrypting LSA secrets for an account ( srvadmin ) which was set up for autologon. 
6. This srvadmin account had local administrator rights over all servers (aside from Domain Controllers) in the domain so the tester was able to log into the MS01.INLANEFREIGHT.LOCAL host and retrieve a Kerberos TGT ticket for a logged in user, pramirez , who was part of the Tier I Server Admins group which granted the account DCSync rights over the domain object. This attack can be utilized to retrieve the NTLM password hash for any user in the domain, resulting in domain compromise and persistence via a Golden Ticket. 
7. The tester used the Rubeus tool to extract the Kerberos TGT ticket for the pramirez user and perform a Pass-the-Ticket attack to authenticate as this user. 
8. Finally, the tester was able to perform a DCSync attack after successfully authenticating with this user account via the Mimikatz tool which ended in domain compromise. 

## Detailed reproduction steps for this attack chain are as follows: 
Upon connecting to the network, the tester started the Responder tool and was able to capture a password hash for the bsmith user by spoofing NBT-NS/LLMNR traffic on the local network segment. 

Detailed reproduction steps for this attack chain are as follows: Upon connecting to the network, the tester started the Responder tool and was able to capture a password hash for the bsmith user by spoofing NBT-NS/LLMNR traffic on the local network segment. $ sudo responder -I eth0 -wrfv __ .----.-----.-----.-----.-----.-----.--| |.-----.----. | _| -__|__ --| _ | _ | | _ || -__| _| |__| |_____|_____| __|_____|__|__|_____||_____|__| |__| NBT-NS, LLMNR & MDNS Responder 3.0.6.0 <SNIP> [+] Generic Options: Responder NIC [eth0] Responder IP [192.168.195.168] Challenge set [random] Don't Respond To Names ['ISATAP'] [+] Current Session Variables: Responder Machine Name [WIN-TWWXTGD94CV] Responder Domain Name [3BKZ.LOCAL] Responder DCE-RPC Port [47032] [+] Listening for events... <SNIP> [SMB] NTLMv2-SSP Client : 192.168.195.205 [SMB] NTLMv2-SSP Username : INLANEFREIGHT\bsmith [SMB] NTLMv2-SSP Hash : bsmith::INLANEFREIGHT:7ecXXXXXX98ebc:73D1B2XXXXXXXXXXX45085A651:010100000000000000B588D9F766D801191BB2236 A5FAAA50000000002000800330042004B005A0001001E00570049004E002D005400570057005800540047004400390034004300 560004003400570049004E002D00540057005700580054004700440039003400430056002E00330042004B005A002E004CXXXXX XXXXXXXXXXXXXXXXXXXXXXXXXXX2E004C004F00430041004C000700080000B588D9F766D80106000400020000000800300030 0000000000000001000000002000002CAE5BF3BB1FD2F846A280AEF43A8809C15207BFCB4DF5A580BA1B6FCAF6BBCE0A001000 000000000000000000000000000000000900280063006900660073002F003100390032002E003100360038002E00310039003500 2E00310036003800000000000000000000000000 <SNIP> Figure 1: Retrieving Password Hash with Responder 